<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>إدارة المنصة | Minecraft Library</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--bg:#09090b;--card:#18181b;--border:#27272a;--accent:#3b82f6;--text:#fafafa;--text-sub:#a1a1aa;--success:#22c55e;--error:#ef4444;--input:#0c0c0e}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif;margin:0;padding:0;overflow-x:hidden;line-height:1.6;-webkit-user-select:none;user-select:none}input,textarea,select,input::placeholder,textarea::placeholder{-webkit-user-select:text!important;user-select:text!important}.hidden{display:none!important}.auth-container{max-width:400px;margin:40px auto;padding:25px;background:var(--card);border:1px solid var(--border);border-radius:20px}.main-panel{max-width:800px;margin:0 auto;padding-bottom:80px}.nav-card{background:rgba(24,24,27,0.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);display:flex;justify-content:space-around;padding:5px 0;position:sticky;top:0;z-index:1000}.nav-btn{background:transparent;border:none;color:var(--text-sub);cursor:pointer;padding:10px;border-radius:12px;display:flex;flex-direction:column;align-items:center;gap:4px;font-size:0.7rem;width:75px;outline:none}.nav-btn.active{color:var(--accent);background:rgba(59,130,246,0.1)}.nav-btn i{font-size:1.2rem}.view-content{padding:15px}.section-card{background:var(--card);border:1px solid var(--border);border-radius:15px;padding:20px;margin-bottom:15px}.form-group{margin-bottom:15px;position:relative}label{display:block;margin-bottom:5px;font-weight:600;font-size:0.85rem}input,select,textarea{width:100%;padding:12px;background:var(--input);border:1px solid var(--border);border-radius:10px;color:#fff;outline:none;font-size:0.95rem}input:focus,textarea:focus{border-color:var(--accent)}textarea{min-height:140px;line-height:1.5}.char-counter{position:absolute;top:0;left:0;font-size:0.7rem;color:var(--accent)}.hint{font-size:0.7rem;color:var(--text-sub);margin-top:4px;display:block;background:rgba(255,255,255,0.03);padding:6px;border-radius:6px;border-right:3px solid var(--accent)}img.preview-box{width:100%;max-height:180px;object-fit:contain;border-radius:10px;margin-bottom:12px;background:#000;border:1px dashed var(--border)}.profile-circle{width:90px;height:90px;border-radius:50%;object-fit:cover;margin:0 auto 12px;display:block;border:2.5px solid var(--accent);background:var(--bg)}.btn{width:100%;padding:14px;border:none;border-radius:10px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;font-size:0.9rem;outline:none}.btn:active{transform:scale(0.97);opacity:0.8}.btn-primary{background:var(--accent);color:#fff}.btn-danger{background:rgba(239,68,68,0.1);color:var(--error);border:1px solid var(--error)}.toast{position:fixed;bottom:20px;right:20px;background:#18181b;padding:12px 20px;border-radius:10px;border-right:4px solid var(--accent);z-index:2000;transition:0.3s;font-size:0.85rem;display:flex;align-items:center;gap:10px}.mod-card{background:var(--input);border:1px solid var(--border);border-radius:12px;margin-bottom:12px;overflow:hidden}.mod-card-main{display:flex;gap:10px;padding:10px}.mod-thumb{width:75px;height:75px;border-radius:8px;object-fit:cover;background:#000}.mod-info{flex:1}.mod-info h4{margin:0 0 4px;font-size:0.9rem}.mod-stats{display:flex;flex-wrap:wrap;gap:8px;font-size:0.65rem;color:var(--text-sub);margin-bottom:4px}.mod-date{font-size:0.6rem;color:#666;display:block}.mod-actions{padding:6px;background:rgba(255,255,255,0.02);border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(4,1fr);gap:4px}.btn-sm{background:var(--card);border:1px solid var(--border);color:var(--text);padding:8px 0;font-size:0.7rem;border-radius:6px;cursor:pointer;outline:none}.btn-sm:active{transform:scale(0.95);background:#222}
</style>
</head>
<body>
<div id="modalContainer" class="hidden"></div>
<div id="authSection" class="auth-container">
<h2 id="authTitle" style="text-align:center;margin-bottom:15px"><i class="fas fa-shield-alt"></i> الدخول للمنصة</h2>
<div id="registerFields" class="hidden">
<img id="regPrev" class="profile-circle" src="https://placehold.co/100?text=Avatar">
<div class="form-group"><label>الاسم العام</label><input type="text" id="regFullName"></div>
<div class="form-group"><label>رابط الصورة</label><input type="url" id="regAvatar" oninput="updatePreview(this.value, 'regPrev')"></div>
</div>
<div class="form-group">
<label>اسم المستخدم @</label><span class="char-counter" id="c_auth_user">30</span>
<input type="text" id="authUsername" maxlength="30" oninput="updateCounter(this, 'c_auth_user'); validateUser(this)">
<small class="hint" id="userHint">حروف لاتينية صغيرة، أرقام، والرموز ( - _ . & ) فقط.</small>
</div>
<div class="form-group"><label>كلمة السر</label><input type="password" id="authPassword"></div>
<button class="btn btn-primary" onclick="processAuth()">تأكيد العملية</button>
<p style="text-align:center;font-size:0.8rem;margin-top:15px;cursor:pointer;color:var(--accent)" id="toggleAuth">إنشاء حساب جديد</p>
</div>

<div id="mainSection" class="main-panel hidden">
<nav class="nav-card">
<button class="nav-btn" id="btn-home" onclick="showTab('home')"><i class="fas fa-house"></i>الرئيسية</button>
<button class="nav-btn" id="btn-publish" onclick="showTab('publish')"><i class="fas fa-plus-square"></i>نشر</button>
<button class="nav-btn" id="btn-edit" onclick="showTab('edit')"><i class="fas fa-folder-open"></i>أعمالي</button>
<button class="nav-btn" id="btn-profile" onclick="showTab('profile')"><i class="fas fa-user-circle"></i>حسابي</button>
</nav>

<div id="tab-home" class="view-content hidden">
<h3 id="welcomeMsg" style="color:var(--accent);margin-bottom:10px"></h3>
<div class="section-card">
<p style="font-size:0.9rem">مرحباً بك مجدداً. يمكنك الآن إدارة ملفاتك الشخصية ومحتوى موداتك من مكان واحد بكل سهولة.</p>
<button class="btn btn-primary" style="margin-top:15px" onclick="window.location.href='https://tamaa-pro.github.io/minecraft_bedrock_library/mods/mc-list'">
<i class="fas fa-list"></i> فتح القائمة العامة
</button>
</div>
</div>

<div id="tab-publish" class="view-content hidden">
<div class="section-card">
<h3 id="formTitle" style="font-size:1.1rem;margin-bottom:15px"><i class="fas fa-upload"></i> نشر عنصر جديد</h3>
<img id="pubPrev" class="preview-box hidden">
<div class="form-group"><label>رابط الغلاف</label><input type="url" id="p_cover" oninput="updatePreview(this.value, 'pubPrev')"></div>
<div class="form-group"><label>عنوان المود</label><input type="text" id="p_title" maxlength="100"></div>
<div class="form-group"><label>رابط التحميل</label><input type="url" id="p_dl"></div>
<div class="form-group"><label>النوع</label><select id="p_type"><option value="mod">Mod</option><option value="map">Map</option><option value="data_pack">Data Pack</option><option value="texture_pack">Texture Pack</option></select></div>
<div class="form-group" style="display:flex;gap:8px">
<div style="flex:1"><label>الإصدار</label><input type="text" id="p_ver" maxlength="30"></div>
<div style="flex:1"><label>التحديث</label><input type="text" id="p_mc" maxlength="30"></div>
</div>
<div class="form-group"><label>وصف قصير</label><span class="char-counter" id="c_p_short">50</span><input type="text" id="p_short" maxlength="50" oninput="updateCounter(this, 'c_p_short')"></div>
<div class="form-group"><label>وصف مفصل</label><span class="char-counter" id="c_p_long">1000</span><textarea id="p_long" maxlength="1000" oninput="updateCounter(this, 'c_p_long'); adjustHeight(this)"></textarea></div>
<div style="display:flex;gap:10px">
<button class="btn btn-primary" id="saveBtn" style="flex:1" onclick="submitMod()"><i class="fas fa-check"></i> حفظ</button>
<button class="btn btn-danger hidden" id="cancelEdit" style="flex:1" onclick="cancelEditMode()"><i class="fas fa-times"></i> إلغاء</button>
</div>
</div>
</div>

<div id="tab-edit" class="view-content hidden">
<div style="display:flex;gap:8px;margin-bottom:12px">
<input type="text" id="searchMod" placeholder="بحث..." oninput="renderMyMods()" style="flex:2">
<select id="filterType" onchange="renderMyMods()" style="flex:1"><option value="all">الكل</option><option value="mod">Mods</option><option value="map">Maps</option></select>
</div>
<div id="myModsList"></div>
</div>

<div id="tab-profile" class="view-content hidden">
<div class="section-card">
<img id="profPrev" class="profile-circle">
<div class="form-group"><label>اسم المستخدم (ثابت)</label><input type="text" id="pr_user" readonly style="opacity:0.5"></div>
<div class="form-group"><label>رابط الصورة</label><input type="url" id="pr_avatar" oninput="updatePreview(this.value, 'profPrev')"></div>
<div class="form-group"><label>الالاسم العام</label><input type="text" id="pr_name"></div>
<div class="form-group"><label>كلمة السر الجديدة</label><input type="password" id="pr_pass"></div>
<div style="display:flex;gap:10px">
<button class="btn btn-primary" style="flex:1" onclick="updateProfile()">تحديث الحساب</button>
<button class="btn btn-danger" style="flex:1" onclick="logout()"><i class="fas fa-sign-out-alt"></i> خروج</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
<script>
const JB_KEY = "$2a$10$F5TR7pSKPRRNAeBzsdxQ4.NYog8xHGUi0hektkor0q/QWFVXzba3q";
const JB_ID = "69a3f2b1d0ea881f40e41d45";
const AW_CONF = { p: '69922bf4002571605f46', d: '69922c8e001dbb613d69', c: 'mods' };
const { Client, Databases, ID, Query } = Appwrite;
const sdk = new Client().setEndpoint('https://cloud.appwrite.io/v1').setProject(AW_CONF.p);
const db = new Databases(sdk);

let currentUser = null;
let myModsList = [];
let editingModId = null;

function showToast(m, type='success') {
    const t = document.createElement('div'); t.className = 'toast';
    t.style.borderRight = `4px solid ${type==='success'?'var(--success)':'var(--error)'}`;
    t.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':'fa-exclamation-triangle'}"></i> ${m}`;
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 2500);
}

function updateCounter(el, id) { document.getElementById(id).innerText = el.maxLength - el.value.length; }
function validateUser(el) { el.value = el.value.toLowerCase().replace(/[^a-z0-9-_&.]/g, ''); }
function adjustHeight(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
function updatePreview(url, id) { const img = document.getElementById(id); if(url) { img.src = url; img.classList.remove('hidden'); } else { img.classList.add('hidden'); } }

async function checkSession() {
    const saved = localStorage.getItem('mc_session');
    if(!saved) return;
    const session = JSON.parse(saved);
    if(Date.now() < session.expiry) login(session.user, false);
    else localStorage.removeItem('mc_session');
}

async function processAuth() {
    const uVal = document.getElementById('authUsername').value.trim();
    const pVal = document.getElementById('authPassword').value;
    const isReg = !document.getElementById('registerFields').classList.contains('hidden');
    if(!uVal || !pVal) return showToast("يرجى ملء كافة الخانات", 'error');
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${JB_ID}/latest`, { headers: {"X-Master-Key": JB_KEY} });
        let bin = (await res.json()).record;
        if(isReg) {
            if(bin.us.find(u => u.username === uVal)) return showToast("المستخدم موجود بالفعل", 'error');
            const newUser = { full_name: document.getElementById('regFullName').value, avatar: document.getElementById('regAvatar').value || "https://placehold.co/100", username: uVal, password: pVal };
            bin.us.push(newUser);
            await fetch(`https://api.jsonbin.io/v3/b/${JB_ID}`, { method: 'PUT', headers: {"Content-Type": "application/json", "X-Master-Key": JB_KEY}, body: JSON.stringify(bin) });
            login(newUser, true);
        } else {
            const found = bin.us.find(u => u.username === uVal && u.password === pVal);
            if(found) login(found, true); else showToast("بيانات خاطئة", 'error');
        }
    } catch(e) { showToast("فشل في الاتصال", 'error'); }
}

function login(u, save) {
    currentUser = u;
    if(save) {
        const session = { user: u, expiry: Date.now() + (24 * 60 * 60 * 1000) };
        localStorage.setItem('mc_session', JSON.stringify(session));
    }
    document.getElementById('authSection').classList.add('hidden');
    document.getElementById('mainSection').classList.remove('hidden');
    document.getElementById('welcomeMsg').innerText = "أهلاً بك، " + u.full_name;
    document.getElementById('pr_user').value = "@" + u.username;
    document.getElementById('pr_name').value = u.full_name;
    document.getElementById('pr_avatar').value = u.avatar;
    updatePreview(u.avatar, 'profPrev');
    showTab('home');
}

function logout() { localStorage.removeItem('mc_session'); window.location.reload(); }

function showTab(tabId) {
    document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.remove('hidden');
    const btn = document.getElementById('btn-' + tabId);
    if(btn) btn.classList.add('active');
    if(tabId === 'edit') fetchMyMods();
}

async function fetchMyMods() {
    const container = document.getElementById('myModsList');
    container.innerHTML = '<p style="text-align:center;padding:20px;color:var(--text-sub)">جاري التحميل...</p>';
    try {
        const res = await db.listDocuments(AW_CONF.d, AW_CONF.c, [Query.equal('author_handle', "@" + currentUser.username)]);
        myModsList = res.documents;
        renderMyMods();
    } catch(e) { container.innerHTML = '<p style="text-align:center">فشل جلب البيانات</p>'; }
}

function formatDT(str) { return new Date(str).toLocaleString('en-US', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }); }

function renderMyMods() {
    const q = document.getElementById('searchMod').value.toLowerCase();
    let mods = myModsList.filter(m => m.title.toLowerCase().includes(q));
    const container = document.getElementById('myModsList');
    container.innerHTML = mods.map(m => `
        <div class="mod-card">
            <div class="mod-card-main">
                <img src="${m.cover_url}" class="mod-thumb" onerror="this.src='https://placehold.co/85'">
                <div class="mod-info">
                    <h4>${m.title}</h4>
                    <div class="mod-stats">
                        <span><i class="fas fa-eye"></i> ${m.views}</span>
                        <span><i class="fas fa-thumbs-up"></i> ${m.likes}</span>
                        <span><i class="fas fa-download"></i> ${m.downloads || 0}</span>
                    </div>
                    <span class="mod-date">نُشر: ${formatDT(m.$createdAt)}</span>
                    <span class="mod-date">تعديل: ${formatDT(m.updated_at || m.$createdAt)}</span>
                </div>
            </div>
            <div class="mod-actions">
                <button class="btn-sm" onclick="startEdit('${m.$id}')"><i class="fas fa-edit"></i></button>
                <button class="btn-sm" style="color:var(--error)" onclick="confirmDelete('${m.$id}')"><i class="fas fa-trash"></i></button>
                <button class="btn-sm" onclick="copyL('${m.$id}')"><i class="fas fa-copy"></i></button>
                <button class="btn-sm" onclick="window.location.href='https://tamaa-pro.github.io/minecraft_bedrock_library/mods/download#${m.$id}'"><i class="fas fa-external-link-alt"></i></button>
            </div>
        </div>
    `).join('');
}

function confirmDelete(id) {
    const modal = document.getElementById('modalContainer');
    modal.innerHTML = `<div class="modal-overlay"><div class="modal-card" style="background:var(--card);padding:20px;border-radius:15px;width:90%;max-width:350px;text-align:center;border:1px solid var(--border)"><h3>حذف؟</h3><div style="display:flex;gap:10px;margin-top:15px"><button class="btn btn-primary" style="background:var(--error);flex:1" onclick="deleteM('${id}')">حذف</button><button class="btn btn-primary" style="background:#444;flex:1" onclick="closeModal()">إلغاء</button></div></div></div>`;
    modal.classList.remove('hidden');
}
function closeModal() { document.getElementById('modalContainer').classList.add('hidden'); }

async function deleteM(id) { try { await db.deleteDocument(AW_CONF.d, AW_CONF.c, id); showToast("تم الحذف"); closeModal(); fetchMyMods(); } catch(e) { showToast("فشل الحذف", 'error'); } }

async function submitMod() {
    const now = new Date().toISOString();
    const data = {
        title: document.getElementById('p_title').value,
        cover_url: document.getElementById('p_cover').value,
        download_url: document.getElementById('p_dl').value,
        item_type: document.getElementById('p_type').value,
        mod_version: document.getElementById('p_ver').value,
        target_mc: document.getElementById('p_mc').value,
        short_desc: document.getElementById('p_short').value,
        long_desc: document.getElementById('p_long').value,
        author_handle: "@" + currentUser.username,
        updated_at: now
    };
    if(!data.title || !data.cover_url || !data.download_url) return showToast("أكمل البيانات", 'error');
    try {
        if(editingModId) { await db.updateDocument(AW_CONF.d, AW_CONF.c, editingModId, data); showToast("تم التحديث"); cancelEditMode(); }
        else { data.likes=0; data.dislikes=0; data.views=0; data.downloads=0; await db.createDocument(AW_CONF.d, AW_CONF.c, ID.unique(), data); showToast("تم النشر"); resetF(); }
    } catch(e) { showToast("خطأ في الحفظ", 'error'); }
}

function startEdit(id) {
    const m = myModsList.find(x => x.$id === id);
    editingModId = id;
    document.getElementById('p_title').value = m.title;
    document.getElementById('p_cover').value = m.cover_url;
    document.getElementById('p_dl').value = m.download_url;
    document.getElementById('p_type').value = m.item_type;
    document.getElementById('p_ver').value = m.mod_version;
    document.getElementById('p_mc').value = m.target_mc;
    document.getElementById('p_short').value = m.short_desc;
    document.getElementById('p_long').value = m.long_desc;
    updatePreview(m.cover_url, 'pubPrev');
    document.getElementById('formTitle').innerText = "تعديل المود";
    document.getElementById('cancelEdit').classList.remove('hidden');
    showTab('publish');
}

function cancelEditMode() { editingModId = null; resetF(); document.getElementById('formTitle').innerText = "نشر عنصر جديد"; document.getElementById('cancelEdit').classList.add('hidden'); showTab('edit'); }
function resetF() { document.querySelectorAll('#tab-publish input, #tab-publish textarea').forEach(i => i.value = ''); document.getElementById('pubPrev').classList.add('hidden'); }
function copyL(id) { navigator.clipboard.writeText(`https://tamaa-pro.github.io/minecraft_bedrock_library/mods/download#${id}`).then(()=>showToast("تم النسخ")); }

document.getElementById('toggleAuth').onclick = function() {
    const isL = document.getElementById('authTitle').innerText.includes('الدخول');
    document.getElementById('authTitle').innerText = isL ? 'إنشاء حساب جديد' : 'الدخول للمنصة';
    document.getElementById('toggleAuth').innerText = isL ? 'لديك حساب؟ تسجيل الدخول' : 'إنشاء حساب جديد';
    document.getElementById('userHint').classList.toggle('hidden', !isL);
    document.getElementById('registerFields').classList.toggle('hidden');
};

async function updateProfile() {
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${JB_ID}/latest`, { headers: {"X-Master-Key": JB_KEY} });
        let bin = (await res.json()).record;
        const idx = bin.us.findIndex(u => u.username === currentUser.username);
        if(idx !== -1) {
            bin.us[idx].full_name = document.getElementById('pr_name').value;
            bin.us[idx].avatar = document.getElementById('pr_avatar').value;
            if(document.getElementById('pr_pass').value) bin.us[idx].password = document.getElementById('pr_pass').value;
            await fetch(`https://api.jsonbin.io/v3/b/${JB_ID}`, { method: 'PUT', headers: {"Content-Type": "application/json", "X-Master-Key": JB_KEY}, body: JSON.stringify(bin) });
            currentUser = bin.us[idx];
            showToast("تم تحديث الحساب");
            const session = JSON.parse(localStorage.getItem('mc_session'));
            session.user = currentUser;
            localStorage.setItem('mc_session', JSON.stringify(session));
        }
    } catch(e) { showToast("خطأ في التحديث", 'error'); }
}

window.onload = checkSession;
document.addEventListener('contextmenu', e => e.preventDefault());
document.onselectstart = e => { if (['INPUT','TEXTAREA'].includes(e.target.tagName)) return true; return false; };
</script>
</body>
</html>
