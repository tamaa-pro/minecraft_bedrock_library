<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>المكتبة العامة | Minecraft Bedrock</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--bg:#09090b;--card:#18181b;--border:#27272a;--accent:#3b82f6;--text:#fafafa;--text-sub:#a1a1aa;--success:#22c55e;--error:#ef4444;--input:#0c0c0e}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif;margin:0;padding:0;overflow-x:hidden;line-height:1.6;-webkit-user-select:none;user-select:none}input,select{-webkit-user-select:text!important;user-select:text!important}.hidden{display:none!important}.header-tools{background:var(--card);border-bottom:1px solid var(--border);padding:15px;position:sticky;top:0;z-index:1000;display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}.tool-input{background:var(--input);border:1px solid var(--border);color:#fff;padding:10px;border-radius:10px;font-size:0.85rem;outline:none}.tool-input:focus{border-color:var(--accent)}.btn-icon{background:var(--input);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;font-size:0.85rem}.btn-icon.active{color:var(--accent);border-color:var(--accent)}.main-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;padding:15px;max-width:1400px;margin:0 auto}.mod-card{background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden;display:flex;flex-direction:column;transition:0.2s}.mod-card:active{transform:scale(0.98)}.img-container{padding:5px;width:100%}.mod-img{width:100%;height:auto;display:block;border-radius:13px;background:#000;object-fit:cover}.stats-bar{padding:10px;background:rgba(255,255,255,0.02);display:flex;flex-wrap:wrap;gap:8px;border-bottom:1px solid var(--border)}.stat-item{font-size:0.65rem;color:var(--text-sub);display:flex;align-items:center;gap:4px}.stat-item i{color:var(--accent);font-size:0.8rem}.action-bar{padding:10px;display:grid;grid-template-columns:1fr 45px 45px;gap:8px}.action-btn{background:var(--input);border:1px solid var(--border);color:#fff;padding:10px;border-radius:10px;font-size:0.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px}.action-btn.saved{color:#f59e0b;border-color:#f59e0b}.pagination{display:flex;justify-content:center;gap:10px;padding:20px;margin-bottom:40px}.page-btn{background:var(--card);border:1px solid var(--border);color:#fff;padding:8px 15px;border-radius:8px;cursor:pointer}.page-btn.active{background:var(--accent);border-color:var(--accent)}.saved-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(10px);z-index:2000;padding:20px;overflow-y:auto}.saved-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid var(--border)}
</style>
</head>
<body>

<div class="header-tools">
<input type="text" id="searchName" class="tool-input" placeholder="بحث بالاسم..." oninput="handleFilterChange()">
<input type="text" id="filterVersion" class="tool-input" placeholder="فلترة التحديث (مثلاً 1.21)" oninput="handleFilterChange()">
<select id="filterType" class="tool-input" onchange="handleFilterChange()">
<option value="all">كل الأنواع</option>
<option value="mod">Mods</option>
<option value="map">Maps</option>
<option value="texture_pack">Texture Packs</option>
<option value="data_pack">Data Packs</option>
</select>
<button id="sortBtn" class="btn-icon" onclick="toggleSort()">
<i class="fas fa-sort-amount-down"></i> <span id="sortText">الأحدث</span>
</button>
<button class="btn-icon" onclick="toggleSavedUI()">
<i class="fas fa-bookmark"></i> المحفوظات
</button>
</div>

<div id="modGrid" class="main-grid"></div>

<div id="paginationBar" class="pagination hidden"></div>

<div id="savedUI" class="saved-overlay hidden">
<div class="saved-header">
<h3><i class="fas fa-bookmark"></i> العناصر المحفوظة</h3>
<button class="btn-icon" onclick="toggleSavedUI()"><i class="fas fa-times"></i></button>
</div>
<div id="savedGrid" class="main-grid"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
<script>
const AW_CONF={p:'69922bf4002571605f46',d:'69922c8e001dbb613d69',c:'mods'};
const {Client,Databases,Query}=Appwrite;
const sdk=new Client().setEndpoint('https://cloud.appwrite.io/v1').setProject(AW_CONF.p);
const db=new Databases(sdk);

let currentPage=0;
let itemsPerPage=50;
let currentSort='desc';
let allSavedIds=JSON.parse(localStorage.getItem('lib_saved')||'[]');

async function fetchMods(){
    const grid=document.getElementById('modGrid');
    grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:50px;color:var(--text-sub)">جاري التحميل...</div>';
    
    let queries=[
        Query.limit(itemsPerPage),
        Query.offset(currentPage*itemsPerPage),
        currentSort==='desc'?Query.orderDesc('$createdAt'):Query.orderAsc('$createdAt')
    ];

    const nameVal=document.getElementById('searchName').value;
    const verVal=document.getElementById('filterVersion').value;
    const typeVal=document.getElementById('filterType').value;

    if(nameVal)queries.push(Query.search('title',nameVal));
    if(verVal)queries.push(Query.equal('target_mc',verVal));
    if(typeVal!=='all')queries.push(Query.equal('item_type',typeVal));

    try{
        const res=await db.listDocuments(AW_CONF.d,AW_CONF.c,queries);
        renderMods(res.documents,'modGrid');
        renderPagination(res.total);
    }catch(e){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--error)">حدث خطأ في جلب البيانات</div>';}
}

function renderMods(mods,containerId){
    const container=document.getElementById(containerId);
    if(mods.length===0){container.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:50px;color:var(--text-sub)">لا توجد عناصر مطابقة</div>';return;}
    
    container.innerHTML=mods.map(m=>{
        const isSaved=allSavedIds.includes(m.$id);
        return `
        <div class="mod-card">
            <div class="img-container">
                <img src="${m.cover_url}" class="mod-img" onerror="this.src='https://placehold.co/400x200?text=No+Image'">
            </div>
            <div class="stats-bar">
                <div class="stat-item"><i class="fas fa-thumbs-up"></i> ${m.likes||0}</div>
                <div class="stat-item"><i class="fas fa-thumbs-down"></i> ${m.dislikes||0}</div>
                <div class="stat-item"><i class="fas fa-eye"></i> ${m.views||0}</div>
                <div class="stat-item"><i class="fas fa-download"></i> ${m.downloads||0}</div>
                <div class="stat-item"><i class="fas fa-calendar-alt"></i> ${new Date(m.$createdAt).toLocaleDateString('en-GB')}</div>
                <div class="stat-item" style="color:var(--accent)"><i class="fas fa-user"></i> ${m.author_handle}</div>
            </div>
            <div class="action-bar">
                <button class="action-btn" onclick="openMod('${m.$id}')"><i class="fas fa-external-link-alt"></i> فتح</button>
                <button class="action-btn ${isSaved?'saved':''}" id="save-${m.$id}" onclick="toggleSave('${m.$id}')">
                    <i class="fa${isSaved?'s':'r'} fa-bookmark"></i>
                </button>
                <button class="action-btn" onclick="shareMod('${m.$id}','${m.title}')"><i class="fas fa-share-alt"></i></button>
            </div>
        </div>`;
    }).join('');
}

function renderPagination(total){
    const bar=document.getElementById('paginationBar');
    if(total<=itemsPerPage){bar.classList.add('hidden');return;}
    bar.classList.remove('hidden');
    const pages=Math.ceil(total/itemsPerPage);
    let html='';
    for(let i=0;i<pages;i++){
        html+=`<button class="page-btn ${i===currentPage?'active':''}" onclick="goToPage(${i})">${i+1}</button>`;
    }
    bar.innerHTML=html;
}

function handleFilterChange(){currentPage=0;fetchMods();}
function goToPage(p){currentPage=p;fetchMods();window.scrollTo(0,0);}
function toggleSort(){currentSort=currentSort==='desc'?'asc':'desc';document.getElementById('sortText').innerText=currentSort==='desc'?'الأحدث':'الأقدم';fetchMods();}

function toggleSave(id){
    let saved=JSON.parse(localStorage.getItem('lib_saved')||'[]');
    const idx=saved.indexOf(id);
    if(idx===-1)saved.push(id);else saved.splice(idx,1);
    localStorage.setItem('lib_saved',JSON.stringify(saved));
    allSavedIds=saved;
    const btn=document.getElementById(`save-${id}`);
    if(btn){
        btn.classList.toggle('saved');
        btn.querySelector('i').className=saved.includes(id)?'fas fa-bookmark':'far fa-bookmark';
    }
    if(!document.getElementById('savedUI').classList.contains('hidden'))loadSavedItems();
}

async function loadSavedItems(){
    const grid=document.getElementById('savedGrid');
    if(allSavedIds.length===0){grid.innerHTML='<p style="text-align:center;grid-column:1/-1">لا توجد عناصر محفوظة</p>';return;}
    try{
        const res=await db.listDocuments(AW_CONF.d,AW_CONF.c,[Query.equal('$id',allSavedIds)]);
        renderMods(res.documents,'savedGrid');
    }catch(e){grid.innerHTML='<p>فشل تحميل المحفوظات</p>';}
}

function toggleSavedUI(){
    const ui=document.getElementById('savedUI');
    ui.classList.toggle('hidden');
    if(!ui.classList.contains('hidden'))loadSavedItems();
}

function openMod(id){window.location.href=`download.html#${id}`;}
function shareMod(id,title){
    const url=`${window.location.origin}/download.html#${id}`;
    if(navigator.share)navigator.share({title:title,url:url});else{navigator.clipboard.writeText(url);alert("تم نسخ الرابط");}
}

window.onload=fetchMods;
document.addEventListener('contextmenu',e=>e.preventDefault());
</script>
</body>
</html>
