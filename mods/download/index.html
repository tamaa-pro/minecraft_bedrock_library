<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>تحميل | Minecraft Library</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--bg:#09090b;--card:#18181b;--border:#27272a;--accent:#3b82f6;--text:#fafafa;--text-sub:#a1a1aa;--success:#22c55e;--error:#ef4444;--input:#0c0c0e}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif;margin:0;padding:15px;overflow-x:hidden;line-height:1.6;-webkit-user-select:none;user-select:none}input,textarea{-webkit-user-select:text!important;user-select:text!important}.hidden{display:none!important}.container{max-width:480px;margin:0 auto}.main-card{background:var(--card);border:1px solid var(--border);border-radius:20px;overflow:hidden;margin-bottom:15px;position:relative}.cover-wrapper{position:relative;width:100%;background:#000}.cover-img{width:100%;height:auto;display:block}.mod-title-overlay{position:absolute;bottom:10px;right:10px;background:rgba(24,24,27,0.75);backdrop-filter:blur(4px);padding:5px 10px;border-radius:8px;font-size:13px;color:#fff;max-width:85%;border:1px solid rgba(255,255,255,0.1)}.meta-section{padding:15px}.publisher-line{display:flex;align-items:center;gap:10px;margin-bottom:15px;cursor:pointer}.pub-avatar{width:35px;height:35px;border-radius:50%;border:2px solid var(--accent);object-fit:cover}.pub-name{font-weight:700;font-size:0.9rem}.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:15px}.info-item{font-size:0.7rem;color:var(--text-sub);display:flex;align-items:center;gap:5px}.info-item i{color:var(--accent);width:12px}.interaction-bar{display:flex;justify-content:space-between;padding:12px 5px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin-bottom:15px}.stat-btn{background:transparent;border:none;color:var(--text-sub);display:flex;flex-direction:column;align-items:center;gap:3px;font-size:0.7rem;cursor:pointer;transition:0.2s;outline:none}.stat-btn i{font-size:1.1rem}.stat-btn.active-like{color:var(--success)}.stat-btn.active-dislike{color:var(--error)}.dl-button{width:100%;padding:14px;background:var(--accent);color:#fff;border:none;border-radius:12px;font-weight:700;font-size:0.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;outline:none}.desc-card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:15px}.desc-card h3{margin:0 0 10px;font-size:0.9rem;color:var(--accent);border-bottom:1px solid var(--border);padding-bottom:8px}.desc-content{font-size:0.85rem;color:var(--text-sub);white-space:pre-wrap}.action-float{position:fixed;top:15px;left:15px;display:flex;gap:8px;z-index:100}.mini-btn{width:38px;height:38px;border-radius:10px;background:rgba(24,24,27,0.8);backdrop-filter:blur(8px);border:1px solid var(--border);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}.skeleton{background:linear-gradient(90deg, #18181b 25%, #27272a 50%, #18181b 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
</style>
</head>
<body>
<div class="action-float">
<div class="mini-btn" onclick="copyPageLink()"><i class="fas fa-link"></i></div>
<div class="mini-btn" onclick="sharePage()"><i class="fas fa-share-alt"></i></div>
</div>
<div class="container" id="mainContent">
<div id="loading"><div class="main-card skeleton" style="height:350px"></div></div>
<div id="modDetails" class="hidden">
<div class="main-card">
<div class="cover-wrapper"><img id="m_cover" class="cover-img"><div id="m_title" class="mod-title-overlay"></div></div>
<div class="meta-section">
<div class="publisher-line" id="publisherAction"><img id="u_avatar" class="pub-avatar"><span id="u_name" class="pub-name"></span></div>
<div class="info-grid">
<div class="info-item"><i class="fas fa-calendar-plus"></i> <span id="m_date"></span></div>
<div class="info-item" id="edit_box"><i class="fas fa-history"></i> <span id="m_edit"></span></div>
<div class="info-item" id="ver_box"><i class="fas fa-layer-group"></i> <span id="m_ver"></span></div>
<div class="info-item" id="mc_box"><i class="fas fa-cube"></i> <span id="m_mc"></span></div>
<div class="info-item"><i class="fas fa-folder"></i> <span id="m_type"></span></div>
</div>
<div class="interaction-bar">
<button class="stat-btn" id="btnLike" onclick="handleVote('like')"><i class="fas fa-thumbs-up"></i><span id="c_likes">0</span></button>
<button class="stat-btn" id="btnDis" onclick="handleVote('dislike')"><i class="fas fa-thumbs-down"></i><span id="c_dis">0</span></button>
<button class="stat-btn"><i class="fas fa-eye"></i><span id="c_views">0</span></button>
<button class="stat-btn"><i class="fas fa-download"></i><span id="c_dl">0</span></button>
</div>
<button class="dl-button" id="dlAction"><i class="fas fa-external-link-alt"></i> فتح رابط التحميل</button>
</div>
</div>
<div class="desc-card"><h3>وصف المود</h3><div id="m_long" class="desc-content"></div></div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
<script>
const AW_CONF = { p: '69922bf4002571605f46', d: '69922c8e001dbb613d69', c: 'mods' };
const { Client, Databases } = Appwrite;
const sdk = new Client().setEndpoint('https://cloud.appwrite.io/v1').setProject(AW_CONF.p);
const db = new Databases(sdk);
const modId = window.location.hash.substring(1);
let modData = null;

function formatDT(s) { return new Date(s).toLocaleString('en-US', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}); }

async function loadPage() {
    if(!modId) return;
    try {
        modData = await db.getDocument(AW_CONF.d, AW_CONF.c, modId);
        render();
        trackStat('view', 'v_seen_');
        fetchUser(modData.author_handle);
    } catch(e) { document.body.innerHTML = "Error 404"; }
    finally { document.getElementById('loading').remove(); document.getElementById('modDetails').classList.remove('hidden'); }
}

function render() {
    document.getElementById('m_cover').src = modData.cover_url;
    document.getElementById('m_title').innerText = modData.title;
    document.getElementById('m_date').innerText = formatDT(modData.$createdAt);
    if(modData.$updatedAt !== modData.$createdAt) document.getElementById('m_edit').innerText = formatDT(modData.$updatedAt);
    else document.getElementById('edit_box').classList.add('hidden');
    if(modData.mod_version) document.getElementById('m_ver').innerText = modData.mod_version; else document.getElementById('ver_box').classList.add('hidden');
    if(modData.target_mc) document.getElementById('m_mc').innerText = modData.target_mc; else document.getElementById('mc_box').classList.add('hidden');
    document.getElementById('m_type').innerText = modData.item_type;
    updateCountersUI();
    document.getElementById('m_long').innerHTML = modData.long_desc;
    document.getElementById('dlAction').onclick = () => { trackStat('download', 'v_dl_'); window.location.href = modData.download_url; };
    applyVoteStyles();
}

function updateCountersUI() {
    document.getElementById('c_likes').innerText = modData.likes || 0;
    document.getElementById('c_dis').innerText = modData.dislikes || 0;
    document.getElementById('c_views').innerText = modData.views || 0;
    document.getElementById('c_dl').innerText = modData.downloads || 0;
}

async function trackStat(type, prefix) {
    const key = prefix + modId;
    const last = localStorage.getItem(key);
    const now = Date.now();
    if(last && (now - last < 86400000)) return;
    const upd = {}; upd[type === 'view' ? 'views' : 'downloads'] = (modData[type === 'view' ? 'views' : 'downloads'] || 0) + 1;
    await db.updateDocument(AW_CONF.d, AW_CONF.c, modId, upd);
    localStorage.setItem(key, now);
}

async function handleVote(v) {
    const key = 'v_vote_' + modId;
    const old = localStorage.getItem(key);
    let upd = { likes: modData.likes, dislikes: modData.dislikes };
    if(old === v) { 
        upd[v === 'like' ? 'likes' : 'dislikes']--;
        localStorage.removeItem(key);
    } else {
        if(old) upd[old === 'like' ? 'likes' : 'dislikes']--;
        upd[v === 'like' ? 'likes' : 'dislikes']++;
        localStorage.setItem(key, v);
    }
    await db.updateDocument(AW_CONF.d, AW_CONF.c, modId, upd);
    modData.likes = upd.likes; modData.dislikes = upd.dislikes;
    updateCountersUI(); applyVoteStyles();
}

function applyVoteStyles() {
    const v = localStorage.getItem('v_vote_' + modId);
    document.getElementById('btnLike').className = 'stat-btn' + (v === 'like' ? ' active-like' : '');
    document.getElementById('btnDis').className = 'stat-btn' + (v === 'dislike' ? ' active-dislike' : '');
}

async function fetchUser(h) {
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/69a3f2b1d0ea881f40e41d45/latest`, { headers: {"X-Master-Key": "$2a$10$F5TR7pSKPRRNAeBzsdxQ4.NYog8xHGUi0hektkor0q/QWFVXzba3q"} });
        const user = (await res.json()).record.us.find(u => "@" + u.username === h);
        if(user) { 
            document.getElementById('u_avatar').src = user.avatar; 
            document.getElementById('u_name').innerText = user.full_name;
            document.getElementById('publisherAction').onclick = () => window.location.href = `user.html#${user.username}`;
        }
    } catch(e) {}
}

function copyPageLink() { navigator.clipboard.writeText(window.location.href); }
function sharePage() { if(navigator.share) navigator.share({url: window.location.href}); }
window.onload = loadPage;
</script>
</body>
</html>
