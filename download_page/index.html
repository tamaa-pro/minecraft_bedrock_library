<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحة التحميل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
        .loading-circle {
            width: 14px;
            height: 14px;
            border: 2px solid #000;
            border-top: 2px solid lime;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-cat {
            font-size: 16px;
            animation: jump 0.8s ease-in-out infinite;
        }
        .loading-bar {
            width: 14px;
            height: 5px;
            background: lime;
            border-radius: 3px;
            animation: blink 1s infinite;
        }
        .loading-square {
            width: 12px;
            height: 12px;
            background: lime;
            animation: spin 1s linear infinite;
        }
        body {
            margin: 0;
            overflow: hidden;
            height: 100vh;
            touch-action: none;
            user-select: none;
            font-family: Arial, sans-serif;
        }
        .toggle-box-btn {
            position: fixed;
            padding: 3px 6px;
            background: #333;
            color: #ccc;
            border-radius: 0;
            cursor: pointer;
            font-size: 10px;
            z-index: 10002;
            border: none;
        }
        #toggleSuggestionBtn { right: 0; top: 0; }
        #toggleInstructionsBtn { right: 0; bottom: 0; }
        #downloadContainer {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            overflow: hidden;
        }
        .download-box {
            background: #222;
            border-radius: 10px;
            padding: 20px 25px;
            text-align: center;
            max-width: 300px;
            width: 90%;
        }
        .download-title {
            color: #fff;
            margin-bottom: 12px;
            font-size: 20px;
        }
        #fileNameBox {
            margin-bottom: 15px;
            padding: 5px 10px;
            background: #111;
            color: #ccc;
            border-radius: 8px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        #downloadBtn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 250px;
            height: 40px;
            padding: 10px;
            background: #0f0;
            color: #000;
            border-radius: 8px;
            font-weight: bold;
            text-decoration: none;
            font-size: 13px;
            transition: .2s;
        }
        #tryAnywayLink {
            display: none;
            margin-top: 10px;
        }
        #tryAnywayLink a {
            color: #ccc;
            font-size: 12px;
            text-decoration: underline;
            cursor: pointer;
        }
        #downloadSuggestion {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10001;
            background: #222;
            padding: 10px 15px;
            color: #ccc;
            font-size: 11px;
            text-align: center;
            border-bottom: 1px solid #444;
            display: none;
        }
        .instructions-box {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #111;
            color: #ccc;
            padding: 10px 15px;
            font-size: 7px;
            line-height: 1.6;
            border-top: 1px solid #333;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div id="downloadContainer">
        <div class="download-box">
            <h3 class="download-title">صفحة التحميل</h3>
            <div id="fileNameBox">
                <span id="loader"></span>
                <span>جاري استخراج اسم الملف...</span>
            </div>
            <a id="downloadBtn" href="#">تحميل الملف</a>
            <div id="tryAnywayLink">
                <a href="#">تجربة الرابط على أي حال؟</a>
            </div>
        </div>
    </div>

    <div id="downloadSuggestion">
        إذا كنت من المتصفح و لا تملك تطبيق المكتبة ننصحك بتحميل التطبيق للوصول لجميع الإصدارات و التوصل بآخر إصدارات في الوقت الفعلي
        <a href="https://tamaa-pro.github.io/minecraft_bedrock_library/" style="display:inline-block;margin-right:5px;margin-left:5px;padding:2px 8px;border-radius:4px;background:#0a0;color:#fff;font-size:11px;text-decoration:none">فتح صفحة التحميل</a>
    </div>

    <div class="instructions-box">
        <b>
            ● في حال ظهرت صفحة الخطأ 404 فذلك بسبب أن الملف لم يتم نشره بعد ، أو أن هناك خطأ في رابط التحميل .<br>
            ● إذا لم يستجب زر التحميل (و إذا لم يستخرج إسم الملف) يرجى إعادة فتح الصفحة أو تحديثها ، و كذلك التأكد من حالة الشبكة .<br>
            ● إذا ظهر على الزر أن الرابط غير صالح فيعني أنه لم يتم إضافة رابط تحميل أو أن الملف الذي تحاول تحميله غير متاح للتحميل .<br>
            ● في حال إنقطع التحميل عدة مرات و استكمل في كل مرة ، فقد يسبب تلف في الملف و يفشل التثبيت .<br>
            ● إذا كنت تملك إصدار مثبت بالفعل على جهازك فعليك حذفه قبل تثبيت النسخة المنزلت (إلا إذا حملت النسخة المستنسخة) لأنه لا يمكن تحديث الإصدارات من خارج بلاي ستور ، و بالتالي سيفشل التحديث أو التثبيت .
        </b>
    </div>

    <script>
        const autoDownload = false,
              useCircle = false,
              useSquare = false,
              useBar = false,
              useCat = true;
        
        const btn = document.getElementById("downloadBtn"),
              loader = document.getElementById("loader"),
              urlParams = new URLSearchParams(location.search);
        
        let fileUrl = urlParams.get("file");

        // دالة لفحص وجود الملف باستخدام البروكسي
        async function checkFileExists(url) {
            try {
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
                const response = await fetch(proxyUrl, { method: 'HEAD' });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // دالة لتعطيل زر التحميل
        function disableDownloadBtn(reason) {
            btn.textContent = reason || "رابط غير صالح";
            btn.style.background = "#888";
            btn.style.pointerEvents = "none";
            btn.onclick = null;
            
            // إظهار رابط "تجربة الرابط على أي حال" إذا كان هناك ملف ولكن غير متاح
            if(fileUrl && reason === "الملف غير متاح") {
                const tryLink = document.getElementById("tryAnywayLink");
                tryLink.style.display = "block";
                tryLink.querySelector("a").onclick = (e) => {
                    e.preventDefault();
                    // نفس سلوك الزر الأصلي
                    tryLink.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;gap:8px"><span class="loading-circle"></span>جاري التحميل...</div>';
                    setTimeout(() => location.href = fileUrl, 400);
                };
            }
        }

        const showLoadingIcon = () => {
            loader.innerHTML = useCircle ? '<div class="loading-circle"></div>' :
                            useSquare ? '<div class="loading-square"></div>' :
                            useBar ? '<div class="loading-bar"></div>' :
                            useCat ? '<div class="loading-cat">🐈‍⬛</div>' : '⏳';
        };

        const setFileName = (txt) => {
            document.getElementById("fileNameBox").innerHTML = 
                '<i class="fas fa-file-alt" style="color:#ccc;font-size:14px"></i><span style="color:#fff;font-size:13px">' + txt + '</span>';
        };

        // دالة لإخفاء/إظهار العناصر
        function setupToggleBoxes() {
            const suggestionBox = document.getElementById("downloadSuggestion");
            const instructionsBox = document.querySelector(".instructions-box");

            // إنشاء أزرار التبديل
            const toggleSuggestionBtn = document.createElement('button');
            toggleSuggestionBtn.id = 'toggleSuggestionBtn';
            toggleSuggestionBtn.className = 'toggle-box-btn';
            toggleSuggestionBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
            toggleSuggestionBtn.onclick = () => {
                suggestionBox.style.display = suggestionBox.style.display === 'none' ? 'block' : 'none';
            };
            document.body.appendChild(toggleSuggestionBtn);

            const toggleInstructionsBtn = document.createElement('button');
            toggleInstructionsBtn.id = 'toggleInstructionsBtn';
            toggleInstructionsBtn.className = 'toggle-box-btn';
            toggleInstructionsBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
            toggleInstructionsBtn.onclick = () => {
                instructionsBox.style.display = instructionsBox.style.display === 'none' ? 'block' : 'none';
            };
            document.body.appendChild(toggleInstructionsBtn);

            // التحقق من حالة العرض الأولى باستخدام localStorage
            if (!localStorage.getItem('suggestionShown')) {
                // أول مرة يفتح الصفحة - نعرض الصندوق ونضبط العلامة
                suggestionBox.style.display = 'block';
                localStorage.setItem('suggestionShown', 'true');
                
                // إخفاء صندوق الإقتراح بعد 5 ثواني
                setTimeout(() => {
                    suggestionBox.style.display = 'none';
                }, 5000);
            } else {
                // ليس أول مرة - نبقيه مخفيًا
                suggestionBox.style.display = 'none';
            }

            // إخفاء صندوق الملاحظات بعد 6 ثواني (يعمل في كل مرة)
            setTimeout(() => {
                instructionsBox.style.display = 'none';
            }, 6000);
        }

        // التحقق من وجود رابط ملف
        if (fileUrl && fileUrl.startsWith("http")) {
            if (fileUrl.endsWith("/")) fileUrl = fileUrl.slice(0, -1);
            showLoadingIcon();

            // التحقق من صحة الملف
            checkFileExists(fileUrl).then(isValid => {
                if (isValid) {
                    btn.href = fileUrl;
                    btn.onclick = e => {
                        e.preventDefault();
                        btn.innerHTML = '<span class="loading-circle"></span>جاري التحميل';
                        btn.style.background = "#0c0";
                        btn.onclick = null;
                        setTimeout(() => location.href = fileUrl, 400);
                    };
                    
                    setTimeout(() => {
                        try {
                            let name = fileUrl.split("/").pop();
                            setFileName(name);
                        } catch {
                            setFileName("⚠️ خطأ في استخراج الاسم");
                        }
                    }, Math.random() * 2000 + 1000);
                } else {
                    disableDownloadBtn("الملف غير متاح");
                    setFileName("⚠️ الملف غير موجود أو لم ينشر بعد");
                }
            }).catch(() => {
                disableDownloadBtn("خطأ في التحقق من الملف");
                setFileName("⚠️ خطأ في الاتصال");
            });
        } else {
            setFileName("⚠️ رابط غير صالح");
            disableDownloadBtn();
        }

        // تهيئة صناديق الإقتراحات والتعليمات
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(setupToggleBoxes, 100);
        });
    </script>
</body>
</html>
